#!/usr/bin/env python3
"""binglock

Screen lock program using assets generated by badabing

"""

import sys, getopt
from PyQt5.QtWidgets import QApplication, QWidget, QLabel, QLineEdit
from PyQt5.QtGui import QIcon, QPixmap, QRegExpValidator, QFont
from PyQt5.QtCore import Qt, pyqtSlot, QRegExp, QTimer, QTime, QDateTime

pin = ''

class BingLock(QWidget):

    def __init__(self):
        """
        BingLock application
        """
        
        super().__init__()
        self.count = 0
        self.setWindowFlags(Qt.WindowStaysOnTopHint | Qt.FramelessWindowHint)
        self.left = 0
        self.top = 0
        self.width = 1368
        self.height = 768
        self.label = QLabel(self)

        with open('/home/darko/.local/share/catlock/themes/wallpaper.info') as f:
            self.title = f.readline()
            tmp = f.readline()
            self.info = tmp.split("(")[0]
            self.copyright = tmp.split("(")[1]

        self.authorize = QPixmap('/home/darko/.local/share/catlock/themes/wallpaper.authorize.jpg')
        self.locked = QPixmap('/home/darko/.local/share/catlock/themes/wallpaper.locked.jpg')
        self.setGeometry(self.left, self.top, self.width, self.height)
    
        # Create widget
        self.label.setPixmap(self.locked)

        self.textbox = QLineEdit(self)
        self.textbox.setEchoMode(QLineEdit.Password)
        self.textbox.setFocusPolicy(Qt.StrongFocus)
        # https://stackoverflow.com/questions/1247762/regex-for-all-printable-characters
        reg_ex = QRegExp("\P{Cc}\P{Cn}\P{Cs}")
        input_validator = QRegExpValidator(reg_ex, self.textbox)
        self.textbox.setValidator(input_validator)
        self.textbox.move((self.width*.5)-140, self.height*.8)
        self.textbox.resize(280,40)
        self.textbox.hide()

        fnt_20 = QFont("Arial", 20, QFont.Normal)
        fnt_12 = QFont("Arial", 12, QFont.Normal)
        fnt_8 = QFont("Arial", 8, QFont.Normal)
        fnt_80 = QFont('Arial', 60, QFont.Bold)
        fnt_40 = QFont('Arial', 30, QFont.Bold)

        self.titlebox = QLabel(self)
        self.titlebox.setFont(fnt_20)
        self.titlebox.setText(self.title)
        self.titlebox.move(60, 40)
        self.titlebox.setStyleSheet("color: white")
  
        self.infobox = QLabel(self)
        self.infobox.setFont(fnt_12)
        self.infobox.setText(self.info)
        self.infobox.move(60, 80)
        self.infobox.setStyleSheet("color: white")

        self.copybox = QLabel(self)
        self.copybox.setFont(fnt_8)
        self.copybox.setText(self.copyright[:-1])
        self.copybox.move(60, 110)
        self.copybox.setStyleSheet("color: white")

        self.clock = QLabel(self)
        self.clock.setFont(fnt_80)
        self.clock.move(60, 530)
        self.clock.setStyleSheet("color: white")


        self.calendar = QLabel(self)        
        self.calendar.setFont(fnt_40)
        self.calendar.move(60, 650)
        self.calendar.setStyleSheet("color: white")
        self.showTime()
        self.clock.show()
        self.calendar.show()


        timer = QTimer(self)
        timer.timeout.connect(self.showTime)
        timer.start(1000) # update every second

        self.show()

    def showTime(self):
        
        currentTime = QDateTime.currentDateTime()
        adj = 60*60*3
        currentTime = currentTime.addSecs(-adj)

        self.clock.setText(currentTime.toString('h:mm a'))
        self.calendar.setText(currentTime.toString('dddd, MMMM d'))


    def showTime0(self):
        
        QDateTime.currentDateTime()
        currentTime = QTime.currentTime()
        adj = 60*60*3
        currentTime = currentTime.addSecs(-adj)

        displayTxt = currentTime.toString('hh:mm')
        self.clock.setText(displayTxt)

    def keyPressEvent(self, event):
        """
        decode the keypress:

            Key_Escape
                kills input, relock screen

            Key_Return
                force check of valid pin
                clear input buffer

            Key_Backspace
                as expected

        """
        if event.key() == Qt.Key_Escape:
            # self.count += 1
            # if self.count > 10:
            #     self.close() 
            # else: 
            self.label.setPixmap(self.locked)
            self.textbox.setText("")
            self.textbox.hide()

        elif event.key() == Qt.Key_Return:
            if self.textbox.text() == pin:
                self.close() 
            self.textbox.clear()

        elif event.key() == Qt.Key_Backspace:
            self.textbox.setText(self.textbox.text()[:-1])

        else:
            if self.textbox.isHidden():
                self.label.setPixmap(self.authorize)
                self.textbox.show()
                self.textbox.setText(event.text())
            else:
                if self.textbox.hasFocus():
                    if self.textbox.text() == pin:
                        self.close() 
                else:
                    self.textbox.setText(self.textbox.text()+event.text())
                    if self.textbox.text() == pin:
                        self.close() 

    

if __name__ == '__main__':

    try:
        opts, args = getopt.getopt(sys.argv[1:], "p:", ["pin="])
    except getopt.GetoptError:
        print('binglock.py --pin <secret>')
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h':
            print('binglock.py --pin <secret>')
            sys.exit()
        elif opt in ["-p", "--pin"]:
            pin = arg

    app = QApplication(sys.argv)
    ex = BingLock()
    sys.exit(app.exec_())
